import React, { useContext, createContext, useState, useEffect } from "react";
import { onAuthStateChanged } from "firebase/auth";
import { auth, db,storage } from "../config/firebase.js";
import { doc, getDoc, onSnapshot,collection,getDocs,updateDoc,arrayUnion ,query,where,orderBy} from "firebase/firestore";
import { getDownloadURL,ref } from "firebase/storage";
const AuthContext = createContext({ user: null, loading: true,friendStatuses:null, userInfo: null,urls:null,profiles : null,freindRequests:null,userFreindsInfo:null});

export default function AuthContextProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [userInfo, setUserInfo] = useState({});
  const [urls, setUrls] = useState({});  
  const [profiles,setProfiles] = useState({})
  const [freindRequests,setFreindRequests] = useState({})
  const [userChats,setUserChats] = useState({})
  const [friendStatuses, setFriendStatuses] = useState({});
  useEffect(() => {
    const loadAlertUrls = async () => {
      try {
        const docRef = doc(db, "alerts", "alerts");
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          setUrls(snap.data());
        } else {
          console.warn("alerts/alerts doc does not exist");
        }
      } catch (err) {
        console.error("Error loading alert urls:", err);
      }
    };

    loadAlertUrls();
  }, []);
  
  useEffect(() => {
    const loadProfiles = async () => {
      try {  
          const snap = await getDocs(collection(db, "usernames"));
          const data = snap.docs.map(d => ({...d.data(),phone : d.id}));
          setProfiles(data);
      } catch (err) {
        console.error("Error loading alert urls:", err);
      }
    };

    loadProfiles();
  }, []);


  const updateSenderFreindList = async (acceptedAsSender,firebaseUser) =>{
      if (acceptedAsSender.length > 0) {
          const meRef = doc(db, "Users", firebaseUser.uid);

          // add ALL accepted people to my friend list
          for (const req of acceptedAsSender) {
       
            await updateDoc(meRef, {
              FreindList: arrayUnion({freindUid : req.to_id,profileUrl : req.receiverProfileUrl,name : req.receiverName}),
            });
          }
        }
  }


  useEffect(() => {
    let unsubSnapshot = null;

    const unsubAuth = onAuthStateChanged(auth, (firebaseUser) => {
      setUser(firebaseUser || null);
      
      // detach previous snapshot listener if present
      if (unsubSnapshot) {
        try { unsubSnapshot(); } catch (e) {}
        unsubSnapshot = null;
      }

      if (!firebaseUser) {
        // logged out: clear state and stop loading
        setUserInfo({});
        setLoading(false);
        return;
      }

      // attach onSnapshot and keep the unsubscribe in outer scope
      const userDocRef = doc(db, "Users", firebaseUser.uid);
      unsubSnapshot = onSnapshot(
        userDocRef,
        (snap) => {
          if (snap.exists()) {
            const data = snap.data();
            const { name, profileUrl, username, dob, Notification_settings,phone,FreindList } = data;
            setUserInfo({ uid: firebaseUser.uid, email: firebaseUser.email,phone, name, profileUrl, username, dob, Notification_settings,FreindList });
          } else {
            // doc missing - set minimal info
            setUserInfo({ uid: firebaseUser.uid, email: firebaseUser.email });
          }
          // IMPORTANT: stop loading after snapshot resolves
          setLoading(false);
        },
        (err) => {
          console.error("onSnapshot error:", err);
          // stop loading even on error so UI doesn't hang
          setUserInfo({ uid: firebaseUser.uid, email: firebaseUser.email });
        
          setLoading(false);
        }
      );

    const chatsRef = collection(db, "Chats");
    const chatsQuery = query(
      chatsRef,
      where("members", "array-contains", firebaseUser.uid),
      orderBy("lastMessageAt", "desc")  // most recent chat first
    );

    let chatsUnsub = onSnapshot(
      chatsQuery,
      (snap) => {
        const chats = snap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
        }));
        setUserChats(chats);
      },
      (err) => {
        console.error("Chats onSnapshot error:", err);
      }
    );
  
        

      
      const freindRequestsRef = collection(db,"FreindRequests")
      let freindRequestsSnapShot = onSnapshot(freindRequestsRef,(snap)=>{
        const all = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

        // requests where I am sender
        const sent = all.filter(req => req.from_id === firebaseUser.uid);

        // requests where I am receiver
        const received = all.filter(req => req.to_id === firebaseUser.uid);

        const acceptedRequest = sent.filter((doc)=>doc.status === "accepted")

        updateSenderFreindList(acceptedRequest,firebaseUser)
        

        setFreindRequests({ sent, received });
      },(err)=>{
          console.error("onSnapshot error:", err);
          // stop loading even on error so UI doesn't hang
          setUserInfo({ uid: firebaseUser.uid, email: firebaseUser.email });
        
          setLoading(false);
      })

    });

    

    return () => {
      // cleanup both listeners
      try { unsubAuth(); } catch (e) {}
    
      if (unsubSnapshot) {
        try { unsubSnapshot(); } catch (e) {}
      }
      if(freindRequestsSnapShot){
        try{freindRequestsSnapShot()}catch(e) {}
      }
      
    };
  }, []);


  useEffect(() => {
  if (!userInfo?.FreindList) return;

  // clean previous listeners
  let unsubscribers = [];

  userInfo.FreindList.forEach((friend) => {
    const friendRef = doc(db, "Users", friend.freindUid);

    const unsub = onSnapshot(friendRef, (snap) => {
      if (!snap.exists()) return;
      const data = snap.data();

      setFriendStatuses((prev) => ({
        ...prev,
        [friend.freindUid]: {
          status: data.status || "offline",
          lastSeen: data.lastSeen || null,
        },
      }));
    });

    unsubscribers.push(unsub);
  });

  return () => {
    unsubscribers.forEach((fn) => fn && fn());
  };
}, [userInfo?.FreindList]);



  return (
    <AuthContext.Provider value={{ user, loading, userInfo,urls,profiles,freindRequests,userChats,friendStatuses }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  return useContext(AuthContext);
}
